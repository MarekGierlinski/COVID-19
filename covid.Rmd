---
title: "Covid-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache=FALSE)
library(kableExtra)

```

```{r kable_functions}
myKable <- function(df, row.names=FALSE, col.names=NA, digits=2, bootstrap="condensed", caption=NULL) {
  kable(df, format="html", row.names=row.names, col.names=col.names, digits=digits, caption=caption) %>% kable_styling(bootstrap_options=bootstrap, full_width=FALSE, position="left", font_size=12)
}
```


```{r read_data}
loadd(covid. covid_sel)
```

```{r all_plot, fig.width=6, fig.height=3}
g <- covid_sel %>%
  mutate(country = factor(country, levels=countries)) %>% 
  basic_plot()
g

ggsave("fig/cases.png", plot=g, device="png", width=6, height=3, dpi=300)
```

```{r linear_models}
shifts_cases <- linear_shifts(covid, "cases")
shifts_deaths <- linear_shifts(covid, "deaths",  val.min=10)

myKable(shifts_cases)
myKable(shifts_deaths)
```


```{r normalized_plot, fig.width=6, fig.height=3}
g <- plot_shifted(covid_sel, what="cases")
g
ggsave("fig/shifted.png", plot=g, device="png", width=6, height=3, dpi=300)
```

```{r uk, fig.width=4, fig.height=3}
d <- covid %>% shift_days(shifts_cases)
d_eu <- d %>% filter(country %in% countries_eu)
d_uk <- d %>% filter(country == "United Kingdom")
g <- basic_plot(d_eu, x="days", xlab="Normalized day", palette=rep("grey",10), shps=rep(1, 10)) +
  theme(legend.position = "none") +
  geom_point(data=d_uk, shape=21, fill="royalblue", colour="black", size=2.5) +
  geom_line(data=d_uk, colour="black")
g

ggsave("fig/uk_eu.png", plot=g, device="png", width=6, height=3, dpi=300)
```

```{r china, fig.width=4, fig.height=3}
g <- covid %>%
  filter(country=="China") %>%
ggplot(aes(date, new_cases)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank()) +
  geom_point() +
  ylim(0, 4500) +
  labs(x = "Date", y = "Daily reported cases")
g

ggsave("fig/china.png", plot=g, device="png", width=6, height=3, dpi=300)
```

```{r deaths_ratio, fig.width=5, fig.height=3}
d <- covid %>% 
  group_by(country) %>% 
  summarise(deaths = sum(NewDeaths), cases = sum(new_cases)) %>% 
  mutate(ratio = deaths / cases) %>% 
  arrange(ratio) %>% 
  mutate(country = as_factor(country)) %>% 
  filter(deaths > 0) %>% 
  mutate(rate = map2(deaths, cases, ~prop.test(.x, .y, conf.level=0.95) %>% broom::tidy())) %>%
  unnest(rate)
  
g <- ggplot(d, aes(x=country, y=estimate, ymin=conf.low, ymax=conf.high)) +
  theme_bw() +
  theme(panel.grid.minor = element_blank()) +
  geom_errorbar(width=0.3) +
  geom_point() +
  coord_flip() +
  labs(x=NULL, y="Reported deaths / reported cases") +
  geom_hline(yintercept = 0.034, colour="red", linetype="dashed")
g

ggsave("fig/death_ratio.png", plot=g, device="png", width=6, height=3, dpi=300)
```


```{r slopes, fig.width=4, fig.height=3}
g <- plot_doubling_times(covid, "cases", val.min=100, lab="Reported cases")
g
ggsave("fig/doubling_cases.png", plot=g, device="png", width=6, height=3, dpi=300)

g <- plot_doubling_times(covid, "deaths", val.min=10, lab="Reported deaths")
g
ggsave("fig/doubling_deahts.png", plot=g, device="png", width=6, height=3, dpi=300)
```


```{r slope_explanation, fig.width=4, fig.height=4}
g <- covid %>%
  shift_days(shifts_cases) %>% 
  filter(country == "United Kingdom" & cases > 100) %>% 
ggplot(aes(x=days, y=log2(cases))) +
  theme_bw() +
  geom_smooth(method = "lm", level=0.95) +
  geom_point(size=1.5) +
  labs(x= "Normalized date", y=expression(log[2]~cases))

g
ggsave("fig/slope_explanation.png", plot=g, device="png", width=6, height=3, dpi=300)
```


```{r normalized_deaths}
g <- plot_shifted(covid_sel, what="deaths", val.min=10)
g
ggsave("fig/deaths.png", plot=g, device="png", width=6, height=3, dpi=300)

```